#!/usr/bin/env python
import os

from duckietown_utils import logger, DuckietownConstants
from duckietown_utils.constants import get_machines_files_path
from duckietown_utils.exceptions import wrap_script_entry_point
from duckietown_utils.scuderia import get_scuderia_contents
import duckietown_utils.col_logging

def create_machines_main():
    scuderia = get_scuderia_contents() 
    fn = get_machines_files_path()
    
    machines_contents = create_machines(scuderia)
    with open(fn, 'w') as f:
        f.write(machines_contents)
    logger.info('Written machines file on %s' % fn)

def create_machines(scuderia_contents):
    """ Returns XML string """
    
    start = """<!-- DO NOT MODIFY: this is autogenerated -->
    <launch>
    <arg name="env_script_path" default="~/duckietown/environment.sh"/>
    """

    def make_line(entry):
        space = " "*(13-len(entry.robot_name))
        p = """<machine name="%s"  %s address="%s.local" %s user="%s" env-loader="$(arg env_script_path)"/>"""
        return p % (entry.robot_name, space, entry.robot_name, space, entry.username)
    
    names = sorted(scuderia_contents)
    
    s = start
    for name in names:
        entry = scuderia_contents[name]
        s += '\n   ' + make_line(entry)
        
    s += '\n</launch>\n'
    return s

if __name__ == '__main__':
    wrap_script_entry_point(create_machines_main)
